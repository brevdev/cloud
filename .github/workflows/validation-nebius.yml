name: Nebius Validation Tests

on:
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:
        # Allow manual triggering
    pull_request:
        paths:
            - "v1/providers/nebius/**"
            - "internal/validation/**"
            - "v1/**"
        branches: [main]

jobs:
    nebius-validation:
        name: Nebius Provider Validation
        runs-on: ubuntu-latest
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.23.0"

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-

            - name: Install dependencies
              run: make deps

            - name: Run Nebius validation tests
              env:
                  NEBIUS_PUBLIC_KEY_ID: ${{ secrets.NEBIUS_PUBLIC_KEY_ID }}
                  NEBIUS_PRIVATE_KEY_PEM_BASE64: ${{ secrets.NEBIUS_PRIVATE_KEY_PEM_BASE64 }}
                  NEBIUS_SERVICE_ACCOUNT_ID: ${{ secrets.NEBIUS_SERVICE_ACCOUNT_ID }}
                  NEBIUS_PROJECT_ID: ${{ secrets.NEBIUS_PROJECT_ID }}
                  TEST_USER_PRIVATE_KEY_PEM_BASE64: ${{ secrets.TEST_USER_PRIVATE_KEY_PEM_BASE64 }}
                  VALIDATION_TEST: true
              run: |
                  cd v1/providers/nebius
                  go test -v -short=false -timeout=30m ./...

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: nebius-validation-results
                  path: |
                      v1/providers/nebius/coverage.out
